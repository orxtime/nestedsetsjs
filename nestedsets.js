module.exports=function(){var e={Structure:[],Data:{},setItem:function(e,t){this.Data[e]=t},removeItem:function(e){if(void 0!==this.Data[e]){for(var t=0;t<this.Structure.length;t++)if(this.Structure[t].itemId===e){for(var r=this.getChilds(this.Structure[t]._id),i=0;i<r.length;i++)this.removeNode(r[i]._id);this.Structure.splice(t,1)}delete this.Data[e]}},addRoot:function(e){return void 0!==this.Data[e]&&(this.removeNodes(),this.Structure.push({_id:1,lkey:1,rkey:2,depth:1,childs:0,parent_id:0,itemId:e})),1},addNode:function(e,t){if(void 0!==this.Data[t]){var r=this.getNode(e,"new");if(!r)return!1;var i=Math.max.apply(Math,this.Structure.map((function(e){return e._id})))||0;this.Structure=this.Structure.map(e=>(e.lkey>r.rkey&&(e.lkey+=2,e.rkey+=2),e.rkey>=r.rkey&&e.lkey<r.rkey&&(e.rkey+=2),e));var u={_id:i+1,lkey:r.rkey,rkey:r.rkey+1,depth:r.depth+1,childs:0,parent_id:r._id,itemId:t};return(r=this.getNode(e)).childs++,this.Structure.push(u),i+1}},getNode:function(e,t){var r=this.Structure.filter(t=>t._id===e);return!(!Array.isArray(r)||1!==r.length)&&(t?Object.assign({},r[0]):r[0])},removeNode:function(e){var t=this.getNode(e,!0),r=this.getParent(e);return!!t&&(r.childs--,this.Structure=this.getNodes().filter(e=>!(e.lkey>=t.lkey&&e.rkey<=t.rkey)).map(e=>(e.rkey>t.rkey&&(e.lkey=e.lkey>t.lkey?e.lkey-(t.rkey-t.lkey+1):e.lkey,e.rkey=e.rkey-(t.rkey-t.lkey+1)),e)),this.Structure)},moveNode:function(e,t){var r,i=this.getNode(e,!0),u=this.getNode(t,!0),y=i.depth,h=i.rkey,k=i.lkey,n=u.depth,l=u.rkey-1,a=n-y+1,s=h-k+1;l>h?(r=l-k+1-s,this.Structure=this.Structure.map(e=>(e.lkey<=l&&e.rkey>k&&(e.rkey<=h?e.lkey=e.lkey+r:e.lkey>h&&(e.lkey=e.lkey-s),e.rkey<=h&&(e.depth=e.depth+a),e.rkey<=h?e.rkey=e.rkey+r:e.rkey<=l&&(e.rkey=e.rkey-s)),e))):(r=l-k+1,this.Structure=this.Structure.map(e=>(e.rkey>l&&e.lkey<h&&(e.lkey>=k?e.rkey=e.rkey+r:e.rkey<k&&(e.rkey=e.rkey+s),e.lkey>=k&&(e.depth=e.depth+a),e.lkey>=k?e.lkey=e.lkey+r:e.lkey>l&&(e.lkey=e.lkey+s)),e)))},getNodes:function(){return this.Structure.sort((e,t)=>e.lkey>t.lkey?1:e.lkey<t.lkey?-1:0)},removeNodes:function(){this.Structure=[]},getParent:function(e){var t=this.getParents(e);return void 0!==t[t.length-1]&&t[t.length-1]},getParents:function(e){var t=this,r=t.getNode(e);if(!r)return[];var i=t.getNodes().filter(e=>e.lkey<r.lkey&&e.rkey>r.rkey);if(i.length>0){var u=[];i.sort((e,t)=>e.lkey>t.lkey?1:e.lkey<t.lkey?-1:0).map(e=>{e.data=t.Data[e.itemId],u.push(e)}),i=u}return i},getChilds:function(e,t){var r=this,i=r.getNode(e);if(!i)return[];var u=r.getNodes().filter(r=>r.lkey>=i.lkey&&r.rkey<=i.rkey&&e!==r._id&&(void 0===t||r.depth<=i.depth+t));if(u.length>0){var y=[];u.sort((e,t)=>e.lkey>t.lkey?1:e.lkey<t.lkey?-1:0).map(e=>{e.data=r.Data[e.itemId],y.push(e)}),u=y}return u},getBranch:function(e){var t=this,r=t.getNode(e);if(!r)return[];var i=t.getNodes().filter(e=>e.rkey>r.lkey&&e.lkey<r.rkey);if(i.length>0){var u=[];i.sort((e,t)=>e.lkey>t.lkey?1:e.lkey<t.lkey?-1:0).map(e=>{e.data=t.Data[e.itemId],u.push(e)}),i=u}return i},getTree:function(e){var t=this,r=[];return(e=e||t.getNodes()).sort((e,t)=>e.lkey>t.lkey?1:e.lkey<t.lkey?-1:0).map(e=>{e.data=t.Data[e.itemId],r.push(e)}),r},clearAll:function(e){this.Structure=[],this.Data={}},isRoot:function(e){var t=this.getNode(e);return!!t&&0===t.parent_id},isBranch:function(e){var t=this.getNode(e);return!!t&&t.childs>0},isLeaf:function(e){var t=this.getNode(e);return!!t&&0===t.childs},getMaxRightKey:function(){return Math.max.apply(Math,this.Structure.map((function(e){return e.rkey})))},getMaxLeftKey:function(){return Math.max.apply(Math,this.Structure.map((function(e){return e.lkey})))},getCountNodes:function(){return this.Structure.length},checkTree:function(){var e=this.Structure.filter(e=>e.lkey>=e.rkey),t=this.Structure.filter(e=>(e.rkey-e.lkey)%2==0),r=this.Structure.filter(e=>(e.lkey-e.depth+2)%2==1),i=[];return 0!==e.length&&i.push({LeftLessRight:e}),0!==t.length&&i.push({ModKeys:t}),0!==r.length&&i.push({Depth:r}),i},debug:function(e){var t=this,r=[];return(e=e||t.getNodes()).map(e=>{r.push(" ".repeat(e.depth+1)+"> "+JSON.stringify(t.Data[e.itemId])+"(itemId:"+e.itemId+"; nodeId:"+e._id+"; lkey:"+e.lkey+"; rkey:"+e.rkey+"; depth:"+e.depth+"; childs:"+e.childs+")")}),r}};return e};
